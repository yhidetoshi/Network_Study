# Chapter4 Layer2スイッチング
- **内容**
- **Catalystスイッチの初期起動**
  - **スイッチの基本設定と検証**
  - **MACアドレステーブル**
  - **二重モードと速度の設定**
  

  
- **スイッチについて**
    - データリンク層で動作する
    - 各ポートに接続しているノードのMACアドレスを学習し、受信したイーサーネットのMACアドレス基にしてフレームを特定のポートにだけ転送する
    - CSMA/CDでコリジョンドメインを分割できる
    - VLANを実現できる


[キャンパスネットワーク]

![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/campas-net.png)

  
  - **キャンパスネットワーク(構内ネットワーク)**
    - 敷地内にある建物やビル内のフロアを統合したネットワーク全体のこと
    - LAN設計
      - **アクセス層**
        - エンドユーザのPCでスマートフォンなどをネットワークに接続するための**アクセススイッチ**を設置してディストリビューションスイッチと接続する
        - アクセススイッチには必要に応じてVLANやポートセキュリティを実装する
      - **ディストリビューション層**
        - 企業のビルやフロアを束ねる**ディストリビューションスイッチ**を設置し、配下のアクセススイッチのトラフィックを集約してコア層へ転送する
        - ディストリビューションスイッチは、通常VLAN間ルーティングを行うためにL3スイッチが使用される
      - **コア層**
        - ネットワークのバックボーンとなる**コアスイッチ**を設置、配下のディストリビューションスイッチを収容する.
　　    - コアスイッチは高速で大容量のトラフィックを処理する非常に高い信頼性を持つスイッチが必要
  
- メモ
  - `Interface Vlan1, changed state to administratively down`
    - VLAN1インターフェースが管理的に無効化されている状態 
  - **フラッディング**
    - スイッチは該当する宛先MACアドレスがMACアドレステーブルに登録されていない場合、受信したポートを除く全てのポートからフレームを転送する.
  - **フィルタリング**
    - 宛先MACアドレスがMACアドレステーブルに登録されている場合、対象のポートにのみフレームを転送
  - スイッチの電源を入れると、最初にPOSTがハードウェアのテストを開始する
    - 問題がなければ**グリーン色**、問題があれば**オレンジ色**になる
    - スイッチポートの状態は各ポートにあるポートLEDよって確認できる

- **MACアドレステーブル**
  - ダイナミックアドレス
    - フレームを受信したタイミングで自動的に登録され、一定時間通信がなければテーブルから削除される(エージアウと)
    - デフォルトのエージアウと時間は300秒
  - スタティックアドレス
    - 管理者が手動で登録し、エージアウトされない
    - スタティックMACアドレスの登録
      - `(config)#mac address-table static <mac-address> vlan <vlan-id> interface <interface>` 
  - MACアドレステーブルはRAM内に作成されるため、電源が落ちるとデータが消える
    - スタティックアドレスの場合は設定を保存しておくと消えない
  - MACアドレステーブルの空きサイズ超えた場合は、既存のエントリーがエージアウトされてテーブルに空きができるまで、新しいアドレス宛のフレームは全てフラッディングされる 
  
- **MACアドレス**
  - **VLAN番号/MACアドレス/学習タイプ/ポート番号**が保存されている
  - `show mac address-table or show mac-address-table`コマンドで確認できる
  - 1つのスイッチポートに対して、複数のMACアドレスを登録するができる

- **各スイッチポートの色**
  - LEDが点灯していない場合
    - ケーブルが適切に接続されていない
    - 接続先機器の電源がオフになっている
    - ポートを管理的に無効化になっている(shutdown)
    - 正しいポートに接続されていない
    - ケーブルのタイプが正しくない(ケーブル不良)
    - セキュリティ違反などによるerr-disable状態
    - スイッチに電源が投入されていない

- スイッチ
  - **フレームを受信すると受信フレームの送信元MACアドレスと受信ポートを関連付けてMACアドレステーブルに登録する**
  - 受信フレームの宛先MACアドレスを基に転送する
  - 宛先アドレスがMACアドレステーブルにない場合、受信ポート以外に捨ててのポートからフレームを転送する(フラッディング)
  - ブロードキャストアドレスが送信元アドレスになることがないので、MACアドレステーブルに登録されない
  - 『`ffff.ffff.ffff.ffff`』はブロードキャストアドレス
  - IPアドレスを付与すると、スイッチをリモート管理できる、SNMPで接続できたりする
  

- MACアドレステーブル参照,Ports列の表示から考察
  - 1つのポートに複数のMACアドレスが登録されている場合、そのポートはスイッチやハブを介して複数のノードと接続されている
  - VALNが複数設定されているのはトランクポート
  - 学習タイプが"DYNAMIC"になっているのでshotdownポートではない
  - スイッチの1つのポートに対して複数のデバイスを直接接続することはできない

- Catalyst2960シリーズはL2スイッチ
  - イーサネットインターフェースはスイッチポート
  - Layer3のIPアドレスを付与することはできない
  - 代わりにスイッチ内部の仮想的な管理インターフェイスにはIPを割り当てることが可能
  - デフォルトではVLAN1が用意されている
  - コンソール/VTY/AUXはスイッチに対して管理アクセスを行うためのポートなのでIPアドレス設定はできない

- 新規導入したCatalystスイッチに対して、異なるネットワークからTelnetする場合に必要な処理
  - 異なるネットワークにあるスイッチと通信する場合、デフォルトゲートウェイの設定が必要
  - Telnet接続する場合,VTY(仮想端末)ポートへログインするにはデフォルト認証機能が有効なのでパスワードを設定する必要がある
      - IPアドレス設定
      - デフォルトゲートウェイの設定
        - `#show running-config`でデフォゲを確認 
      - VTYパスワードの設定


- 管理インターフェースとデフォルトゲートウェイの設定
```
(config)#interface vlan <vlan-id>
(config-if)#ip address <ip-address> <subnet-mask>
(config-if)#no shutdown
(config)#ip default-gateway <ip-address>
```
- 送信元のMACアドレス
  - MACアドレスは同一ネットワーク内で使用されるLayer2アドレスのため、ルータを経由すると送信元と宛先のMACアドレスは変更される
  - ルータを経由した後はARPによって宛先MACアドレスを取得する
  - Layer3はルータを経由しても変更されない

- オートネゴシーエション
  - 接続している2つのポート同士が対応している通信規格や通信モードの違いを自動的に判定し、最適な設定で通信を行うための機能
  - 全二重の設定コマンド: `(config-if)#duplex full`
  - オートネゴシエーション: `(config-if)#duplex auto`
  - 半二重の設定コマンド：`(config-if)#duplex half`

- `show interface status`コマンド結果の見方
  - status
    - `connected`:ケーブルが接続されてリンクアップの状態
    - `notconnect`:ケーブルが接続されていない、or 接続先が電源OFF
    - `disabled`:shutdownコマンドで管理的に無効
  - 通信モード
    - `full`:duplex fullコマンドで全二重に設定
    - `half`:duplex halfコマンドで半二重に設定
    - `auto`:オートネゴシエーション機能が有効(デフォルト)
    - `a-full`:オートネゴシエーションの結果、全二重になった
    - `a-halt`:オートネゴシエーションの結果、半二重になった
    - 以下、speed
    - `100`:speed 100コマンドで100Mbpsに設定
    - `10`:speed 100コマンドで10Mbpsに設定
    - `auto`:オートネゴシエーション機能が有効(デフォルト)
    - `a-100`:オートネゴシエーションの結果、100Mbpsになっている
