#### Chapter9 リンクステートルーティング
- **内容**
  - **リンクステートルーティング**
  - **OSPFの概要**
  - **OSPFの動作**
  - **OSPF基本設定と検証**
  - **OSPFネットワークタイプ**
  - **OSPFのオプション設定**
  - **OSPFのトラブルシューティング**
  - **OSPFv3**



- **リンクステートルーティングプロトコルの特徴**
  - コンバージェンスはディスタンスベクター型より高速
  - ネイバー関係を確立し、リンクステート情報(LSA)を交換
  - ネットワーク全体のトポロジを把握し、リンクステートデータベースを基に最短パスを決定
  - 最短パスの算出にSPFアルゴリズムを使用
  - 効率的なアップデートにより帯域幅の消費が少ない
  - 階層型のエリア設計により、大規模ネットワークに対応できる
  - VLSMをサポートしている
  - イベントトリガのアップデートを行う
  - 代表的なプロトコルはOSPF、IS-IS


- 大規模なOSPFネットワークにおいて階層型構造を使用するメリット
 
|問題点  　　|説明         |
|:-----------|:------------|
|LSDBが大きくなる|OSPFルータはエリア内でLSAをフラッディングし、共通のLSDBを保持するので、規模が大きくなるとLSAトラフィックが増加し、CPUリソースを消費する|
|SPF計算頻度の増加|ネットワークの拡大に伴い、トポロジが変更される回数が増す。そのために各ルータはSPFの再計算とルーティングテーブルの更新に多くのCPUリソースを消費する|
|ルーティングテーブルが大きくなる|エリア境界と自律システムの境界で、経路集約を行う。シングルエリア環境ではOSPFドメイン内の経路集約が行えないため、ルーティングテーブルのサイズが大きくなりメモリを消費する|

**(*)LSDB(Link State Database)でトポロジーテーブルのこと**

|解決策  　　|説明         |
|:-----------|:------------|
|1           |ネットワークを複数のエリアに分割する改造構造にすることで解決| 
|2           |バックボーンエリア(通過エリア)と標準エリア(非バックボーンエリア)の2階層| 
|3           |マルチエリアOSPFによってLSAフラッティング範囲はエリア内に制限され、不安定なネットワークによる影響もエリア内のルータに抑えることができる| 
|4           |エリア境界では複数の経路を1つに集約でき、ルーティングのオーバーヘッドも減少する| 

- OSPF
 - ネイバーのルータと情報をやり取りする
 - 情報を交換する事を **『アドバタイズ』**と呼ぶ』
   - 交換する情報を**『LSA(リンクステートアドバタイズ)』**
 - ネットワークのタイプ
   - Point-to-Point
     - DR/BDRの選出なし
   - マルチアクセス・ネットワーク
     - Broadcast/Non-Broadcast
     - DR/BDRの選出なし

- **DRの選出**
  - DRやBDRはネットワークセグメントごとに1台ずつ選出される
  - このDRやBDRの選出は、Neighborを確立する際のHelloプロトコルの交換による
  - Helloパケットには,DRやBDRの選出に使用されるプライオリティ値やルータIDなどの情報が入力されている
  - 基本的にはプライオリティ値が一番高いものがDR、2番目に高いものがBDRに選出される
    - (*)プライオリティ値: 
      - [0-255]で手動で設定可能
      - 0にした場合、DRもBDRも選出されない 
      - プライオリティ値が同じ場合、最も高いルータIDを持つものがDRやBDRに選出される

- **DRの役割**
  - DRやDBRが選出されると、各OSPFルータは、この両者とのみ**『アジャセンシー』**を形成する
  - それ以外のOSPFルータ同士は**『ネイバー』**と呼ばれる関係になる
  - アジャセンシーを形成したOSPFルータ間ではLSAの交換が行われ、LSDBが同じになるように同期が図られる
  - 更新などが発生した際には、DRが代表してその情報をマルチキャストによりアナウンスする

    
**[OSPFのBR/BDRの有無のイメージ]**

![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/ospf-lsa.png)
![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/ospf-no-lsa.png)

(引用:http://www.infraexpert.com/study/ospfz7.html)


**[階層化されたOSPFネットワーク図]**

![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/ospf-as.png)

**[ルータの種類]**

|種類  　　　|役割         |
|:-----------|:------------|
|内部ルータ  |すべてのインターフェースが同じエリアに所属しているルータ|
|バックボーンルータ|1以上のインターフェースががバックボーンルータに所属しているルータ|
|ABR         |Area Border Router、2つ以上のエリアに所属しているエリア境界ルータ    |
|ASBR        |AS Boundary Router、非OSPFネットワーク(外部AS)と接続しているAS境界ルータ|


**[基本的なLSAタイプ]**

![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/ospf_stub_area.jpg)

|タイプ   |説明         |
|:-----------|:------------|
|LSAタイプ1 ルータLSA           |直接接続しているリンクの状態を表現するためのLSA.全てのOSPFルータ生成する.発生したそのエリア内でのみフラッディングする|
|LSAタイプ2 ネットワークLSA|マルチアクセスネットワーク上のDRが生成し、DRのIPアドレスやそのネットワークに接続しているルータのリスト、および、サブネットマスクの情報が含まれる。発生したそのエリア内でのみフラディングする|
|LSAタイプ3 ネットワーク集約LSA|エリア内のネットワークアドレスを他のエリアへ通知するためのLSAであり、ABRによって生成される。OSPFドメインドメイン全体にフラディングされる|
|LSAタイプ5 AS外部LSA|外部ドメインのネットワークアドレスをOSPFドメインへアドバタイズするためのLSAであり、外部ドメインの経路情報をOSPFに再配布してり場合にABRによって生成される.OSPFドメイン全体にフラッディングされる|
|||

(*)再配布：あるルーティングプロセスで学習した経路情報を異なるルーティングプロセスの経路として再配布(再配送)する技術のこと


- **OSPFルータが持っているもの**
  - ネイバーテーブル
  - トポロジーテーブル
  - ルーティングテーブル


**[OSPFで使用されるパケット]**

|パケット名  |説明         |
|:-----------|:------------|
|Hello       | ネイバー関係を確立および維持するためのパケット
|DBD         |DataBase Description. LSDBに含まれるLSAのリストをネイバーに提示し、同期するためのパケット |
|LSR|Link State Request. ネイバーにLSAを要求するためのパケット|
|LSU|Link State Update ネイバーから要求されたLSAを送信するためのパケット|
|LSAck|Link State Acknowledgement. DBDやLSUの受信による確認応答|

- **LSDB**(Link State DataBase)
  -  リンクステートデータベースには自身で生成したLSAおよびネイバーから受信したLSAが格納
  -  ネイバー関係は、Helloパケットを使用して確立および維持される
  -  ネイバーがダウンした場合、そのネイバーから受信した全てのLSAを削除

- OSPFのHelloパケット
  - 224.0.0.5のマルチキャストアドレスで定期的に送信される 

- **ルータID**
  - OSPFルータを一意に識別するための名前の代わりとなる識別番号
  - 同じルーティングポリシーを持つルータのグループは**自律システム**もしくは**ドメイン**と呼ぶ
  - ドメイン全体で一意に識別する必要がある
  - 32bit値でIPアドレスの表記と同じになる
  - インタフェースに割り当てられたIPアドレスを利用してどうてきにルータIDを設定できる
  - 管理者が任意に設定することもできる
  - ルータIDはOSPFプロセスを起動(設定)したタイミングで決定する
  - HelloやLSAに含まれる

**ルータIDの優先度**
```
<優先度>

(高)
1: router-id
  <router-idコマンドを使用して明示的に設定>
  
2: ループバックインターフェースの中で最大のIPアドレス
  <router-idコマンドを設定していない場合、ループバックインタフェースの中で最も大きいIPアドレスをルータIDに選択>

3: アクティブなインタフェースの中で最大のIPアドレス
  <ループバックインタフェースを設定していない場合、アクティブなインタフェースの中で最も大きいIPアドレスをルータIDとして選択> 
(低)
```
