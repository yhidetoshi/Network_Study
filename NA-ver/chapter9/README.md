#### Chapter9 リンクステートルーティング
- **内容**
  - **リンクステートルーティング**
  - **OSPFの概要**
  - **OSPFの動作**
  - **OSPF基本設定と検証**
  - **OSPFネットワークタイプ**
  - **OSPFのオプション設定**
  - **OSPFのトラブルシューティング**
  - **OSPFv3**



- **リンクステートルーティングプロトコルの特徴**
  - コンバージェンスはディスタンスベクター型より高速
  - ネイバー関係を確立し、リンクステート情報(LSA)を交換
  - ネットワーク全体のトポロジを把握し、リンクステートデータベースを基に最短パスを決定
  - 最短パスの算出にSPFアルゴリズムを使用
  - 効率的なアップデートにより帯域幅の消費が少ない
  - 階層型のエリア設計により、大規模ネットワークに対応できる
  - VLSMをサポートしている
  - イベントトリガのアップデートを行う
  - 代表的なプロトコルはOSPF、IS-IS


- 大規模なOSPFネットワークにおいて階層型構造を使用するメリット
 
|問題点  　　|説明         |
|:-----------|:------------|
|LSDBが大きくなる|OSPFルータはエリア内でLSAをフラッディングし、共通のLSDBを保持するので、規模が大きくなるとLSAトラフィックが増加し、CPUリソースを消費する|
|SPF計算頻度の増加|ネットワークの拡大に伴い、トポロジが変更される回数が増す。そのために各ルータはSPFの再計算とルーティングテーブルの更新に多くのCPUリソースを消費する|
|ルーティングテーブルが大きくなる|エリア境界と自律システムの境界で、経路集約を行う。シングルエリア環境ではOSPFドメイン内の経路集約が行えないため、ルーティングテーブルのサイズが大きくなりメモリを消費する|

**(*)LSDB(Link State Database)でトポロジーテーブルのこと**

|解決策  　　|説明         |
|:-----------|:------------|
|1           |ネットワークを複数のエリアに分割する改造構造にすることで解決| 
|2           |バックボーンエリア(通過エリア)と標準エリア(非バックボーンエリア)の2階層| 
|3           |マルチエリアOSPFによってLSAフラッティング範囲はエリア内に制限され、不安定なネットワークによる影響もエリア内のルータに抑えることができる| 
|4           |エリア境界では複数の経路を1つに集約でき、ルーティングのオーバーヘッドも減少する| 

- OSPF
 - ネイバーのルータと情報をやり取りする
 - 情報を交換する事を **『アドバタイズ』**と呼ぶ』
   - 交換する情報を**『LSA(リンクステートアドバタイズ)』**
 - ネットワークのタイプ
   - Point-to-Point
     - DR/BDRの選出なし
   - マルチアクセス・ネットワーク
     - Broadcast/Non-Broadcast
     - DR/BDRの選出なし

- **DRの選出**
  - DRやBDRはネットワークセグメントごとに1台ずつ選出される
  - このDRやBDRの選出は、Neighborを確立する際のHelloプロトコルの交換による
  - Helloパケットには,DRやBDRの選出に使用されるプライオリティ値やルータIDなどの情報が入力されている
  - 基本的にはプライオリティ値が一番高いものがDR、2番目に高いものがBDRに選出される
    - (*)プライオリティ値: 
      - [0-255]で手動で設定可能
      - 0にした場合、DRもBDRも選出されない 
      - プライオリティ値が同じ場合、最も高いルータIDを持つものがDRやBDRに選出される

- **DRの役割**
  - DRやDBRが選出されると、各OSPFルータは、この両者とのみ**『アジャセンシー』**を形成する
  - それ以外のOSPFルータ同士は**『ネイバー』**と呼ばれる関係になる
  - アジャセンシーを形成したOSPFルータ間ではLSAの交換が行われ、LSDBが同じになるように同期が図られる
  - 更新などが発生した際には、DRが代表してその情報をマルチキャストによりアナウンスする
  - DRとBDRを選出するのは**『ブロードキャストマルチアクセス』** **『NBMA(ノンブロードキャストマルチアクセス)』**

    
**[OSPFのBR/BDRの有無のイメージ]**

![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/ospf-lsa.png)
![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/ospf-no-lsa.png)

(引用:http://www.infraexpert.com/study/ospfz7.html)


**[階層化されたOSPFネットワーク図]**

![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/ospf-as.png)

**[ルータの種類]**

|種類  　　　|役割         |
|:-----------|:------------|
|内部ルータ  |すべてのインターフェースが同じエリアに所属しているルータ|
|バックボーンルータ|1以上のインターフェースががバックボーンルータに所属しているルータ|
|ABR         |Area Border Router、2つ以上のエリアに所属しているエリア境界ルータ    |
|ASBR        |AS Boundary Router、非OSPFネットワーク(外部AS)と接続しているAS境界ルータ|


**[基本的なLSAタイプ]**

![Alt Text](https://github.com/yhidetoshi/Pictures/raw/master/Network_Study/ospf_stub_area.jpg)

|タイプ   |説明         |
|:-----------|:------------|
|LSAタイプ1 ルータLSA           |直接接続しているリンクの状態を表現するためのLSA.全てのOSPFルータ生成する.発生したそのエリア内でのみフラッディングする|
|LSAタイプ2 ネットワークLSA|マルチアクセスネットワーク上のDRが生成し、DRのIPアドレスやそのネットワークに接続しているルータのリスト、および、サブネットマスクの情報が含まれる。発生したそのエリア内でのみフラディングする|
|LSAタイプ3 ネットワーク集約LSA|エリア内のネットワークアドレスを他のエリアへ通知するためのLSAであり、ABRによって生成される。OSPFドメインドメイン全体にフラディングされる|
|LSAタイプ5 AS外部LSA|外部ドメインのネットワークアドレスをOSPFドメインへアドバタイズするためのLSAであり、外部ドメインの経路情報をOSPFに再配布してり場合にABRによって生成される.OSPFドメイン全体にフラッディングされる|
|||

(*)再配布：あるルーティングプロセスで学習した経路情報を異なるルーティングプロセスの経路として再配布(再配送)する技術のこと


- **OSPFルータが持っているもの**
  - ネイバーテーブル
  - トポロジーテーブル
  - ルーティングテーブル


**[OSPFで使用されるパケット]**

|パケット名  |説明         |
|:-----------|:------------|
|Hello       | ネイバー関係を確立および維持するためのパケット
|DBD         |DataBase Description. LSDBに含まれるLSAのリストをネイバーに提示し、同期するためのパケット |
|LSR|Link State Request. ネイバーにLSAを要求するためのパケット|
|LSU|Link State Update ネイバーから要求されたLSAを送信するためのパケット|
|LSAck|Link State Acknowledgement. DBDやLSUの受信による確認応答|

- **Helloパケットの中身**
  - ルータID
  - ネットワークマスク
  - Hello/Deadインターバル
  - ネイバーリスト
  - エリアID
  - OSPFプライオリティ
  - DR/BDRのIPアドレス
  - 認証パスワード
  - スタブエリアフラグ

- **LSDB**(Link State DataBase)
  -  リンクステートデータベースには自身で生成したLSAおよびネイバーから受信したLSAが格納
  -  ネイバー関係は、Helloパケットを使用して確立および維持される
  -  ネイバーがダウンした場合、そのネイバーから受信した全てのLSAを削除

- OSPFのHelloパケット
  - 224.0.0.5のマルチキャストアドレスで定期的に送信される 

- **ルータID**
  - OSPFルータを一意に識別するための名前の代わりとなる識別番号
  - 同じルーティングポリシーを持つルータのグループは**自律システム**もしくは**ドメイン**と呼ぶ
  - ドメイン全体で一意に識別する必要がある
  - 32bit値でIPアドレスの表記と同じになる
  - インタフェースに割り当てられたIPアドレスを利用してどうてきにルータIDを設定できる
  - 管理者が任意に設定することもできる
  - ルータIDはOSPFプロセスを起動(設定)したタイミングで決定する
  - HelloやLSAに含まれる

**ルータIDの優先度**
```
<優先度>

(高)
1: router-id
  <router-idコマンドを使用して明示的に設定>
  
2: ループバックインターフェースの中で最大のIPアドレス
  <router-idコマンドを設定していない場合、ループバックインタフェースの中で最も大きいIPアドレスをルータIDに選択>

3: アクティブなインタフェースの中で最大のIPアドレス
  <ループバックインタフェースを設定していない場合、アクティブなインタフェースの中で最も大きいIPアドレスをルータIDとして選択> 
(低)
```

- **ループバックインタフェース**
- `interface loopback <number>` コマンドで自由に作成できる論理的(仮想敵)なインタフェース
- リンク障害などでダウンすることがないため、ルータIDに利用するとOSPFルーティングが安定する

|パケット名  |説明         |
|:-----------|:------------|
|DR|Designated Router. LSAの交換を取りまとめる代表ルータ|
|BDR|Backup Designated Router. DRのバックアップとして動作するルータ|
|DROTHER|その他(DR/BDR以外)のルータ|

(マルチアクセスネットワークの場合)

|マルチキャストアドレス|宛先|
|:-----------|:------------|
|224.0.0.5|全OSPFルータ宛|
|224.0.0.6|DR/BDR宛|

(Point to Pointネットワークの場合)
`224.0.0.5`

**OSPFのネイバー関係を確立するのに必要なもの(一致している必要がある)**

1. エリアID
2. Helloインターバル(Hello送信間隔)
3. Deadインターバル(Hello有効時間)
4. 認証設定(認証パスワード)
5. スタブエリアフラグ
6. ネットワークマスク(インターフェースのサブネットマスク)


**(2台のOSPFルータ間でLSDBの同期を完了するまでの手順)**

|状態        |         説明|
|:-----------|:------------|
|DOWN状態|OSPFが起動、あるいはリンクアップした直後で、Helloパケットを受信していない状態.他のOSPFルータも認識していない|
|INIT状態|受信したHelloパケット内のネイバーリストに自身のルータIDがなく、双方向通信はまだ確立されていない状態. 条件を満たしたHelloパケットを受信するとINIT状態になり、ネイバーテーブルに相手のルータIDを追加する|
|2WAY状態|双方でHelloパケットを受信し、お互いに存在を認識した状態. 双方向通信が確立. ネットワークタイプがマルチアクセスネットワークの場合、このタイミングでDB/BDRの選出が行われる|
|EXSTRAT状態|先にDBDパケットの送信を開始するルータ(マスタ)とあらかじめDBDを送信するルータ(スレーブ)を決定している状態|
|EXCHANGE状態|DBDパケットを送信し、自身のLSDBで保持しているLSAのリスト(要約情報)を提示している状態|
|LOADING状態|自身のLSDBに存在しないLSA情報があれば、LSRパケットを送信して要求する. LSRを受信したルータは、要求されたLSAをLSUパケットで通知することでLSDBの同期をとっている状態|
|FULL状態|必要なLSA情報を全て受け取り、LSDBが完全に同期された状態|

**状態繊維**
(DOWN) => (INIT) => (2WAY) => (EXSTART) => (EXCHANGE) => (LOADING) => (FULL)

- DROTHERとDROTHERの通信
  - 2WAY状態で収束する
  - 関係は単なるネイバー

- OSPFのコスト計算
  - 管理者が明示的に設定することが可能だが、設定していない場合には下記の式で計算 
  - `Cost = (帯域幅) / インタフェース帯域幅`  

- コスト計算式の参照帯域幅の変更
```
(config-router)#auto-cost reference-bandwith <ref-bw>

*) ref-bw : 参照帯域幅を1〜4294967
```

- OSPFプライオリティの設定
  - `(config-if)#ip ospf priority <priority>`
  - `priority`: 値を0〜255の範囲で指定、デフォルトは1
  - プライオリティを0にするとDROTHERになる

- OSPFコマンド
  - OSPF確認コマンド 
    - `#show ip ospf interface` 
  - デフォルトルートの登録(自身のルーティングテーブルにデフォルトルートを登録)
    - `(config)#ip route 0.0.0.0 0.0.0.0` 
  - OSPFデフォルトルートアドバタイズ
    - `(config-router)#default-information originate` 

|コマンド  |説明         |
|:-----------|:------------|
|show ip protocols|ルーティングプロセスのパラメータと現在の状態を表示|
|show ip ospf|OSPFの全般的な情報を表示|
|show ip ospf interface|OSPFインターフェースに関する情報の表示|
|show ip ospf database|LSDBの表示|
|show ip ospf neighbor|ネイバー確認|
|show ip ospf interface|特敵のインタフェースのネイバーを表示する|


- OSPF認証
 
|コマンド  |説明         |
|:-----------|:------------|
|プレーンテキスト認証|パスワードを暗号化せずにそのままテキストで交換する方式|
|MD5認証|キーIDトパスワードから各OSPFパケットのハッシュを交換する方式|


- OSPFv3の相違点
  - 送信元アドレスにリンクローカルアドレスを使用
  - 宛先アドレスにはIPv6マルチキャストアドレスを使用
  - 新しいLSAタイプを追加
  - 認証にはIPSecを利用

**OSPFv3ルータのマルチキャストアドレス**

|宛先  　　　|値         |
|:-----------|:------------|
|全OSPFv3ルータ宛|FF02::5|
|DR/BDR宛|FF02::6|
